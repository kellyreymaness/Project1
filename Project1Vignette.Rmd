---
title: "Project 1 Vignette: Reading In and Exploring Data via an API"
author: "Kelly Baker"
date: "9/10/2020"
output: 
  rmarkdown::github_document:
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(DT)
```

# Introduction
<br>
This vignette will walk you through how to connect with data through an API. Specifically, we will look at how to access certain endpoints (tables) as well as how join returned datasets, create new variables, and explore the data.
<br>

## Required Packages
<br>
To get started, we'll need to ensure we have the tools installed and loaded into RStudio to read in, manipulate, summarize, and plot the data. Below is an outline of packages that are required to for this project:
<br>

* **dplyr**: for data manipulation
* **DT**: for creating interactive data tables. 
* **ggplot2**: for plotting and graphing
* **readr**: for reading in data
* **tibble**: for creating special data frames with improved printing properties
* **tidyr**: for reshaping data
* **jsonlite**: for parsing API data
* **httr**: for streaming data from an API
* **knitr**: for creating tables with nic printing properties
<br>

We'll read in the packages using the library() function:
```{r packages, echo=TRUE}
library(dplyr)
library(DT)
library(ggplot2)
library(readr)
library(tibble)
library(tidyr)
library(jsonlite)
library(httr)
library(knitr)
```
<br>

# API Function Calls
<br>

## Return `franchise` data set
```{r fun1, echo=TRUE, message=FALSE, warning=FALSE, error=TRUE}
fetchFran <- function(tab) {
  URL <- "https://records.nhl.com/site/api/franchise"
  franGET <- GET(URL)
  franGET_text <- content(franGET, "text")
  franGET_json <- fromJSON(franGET_text, flatten=TRUE)
  franGET_df <- as.data.frame(franGET_json)
  invisible(franGET_df)
  return(franGET_df)
}
```

## Return `franchise` data by Team Name
```{r fun2, echo=TRUE, message=FALSE, warning=FALSE, error=TRUE}
fetchFranName <- function(tab, name) {
  URL <- "https://records.nhl.com/site/api/franchise"
  franGET <- GET(URL)
  franGET_text <- content(franGET, "text")
  franGET_json <- fromJSON(franGET_text, flatten=TRUE)
  franGET_df <- as.data.frame(franGET_json)
  invisible(franGET_df)
  return(franGET_df %>% filter(data.teamCommonName==name))
}
```

## Return `franchise` data by Team ID
```{r fun3, echo=TRUE, message=FALSE, warning=FALSE, error=TRUE}
fetchFranID <- function(tab, id) {
  URL <- "https://records.nhl.com/site/api/franchise"
  franGET <- GET(URL)
  franGET_text <- content(franGET, "text")
  franGET_json <- fromJSON(franGET_text, flatten=TRUE)
  franGET_df <- as.data.frame(franGET_json)
  invisible(franGET_df)
  return(franGET_df %>% filter(data.id==id))
}
```

## Return `franchise team totals` dataset
```{r fun4}
fetchFranTotal <- function(tab, ...) {
  URL <- "https://records.nhl.com/site/api/franchise-team-totals"
  franGET <- GET(URL)
  franGET_text <- content(franGET, "text")
  franGET_json <- fromJSON(franGET_text, flatten=TRUE)
  franGET_df <- as.data.frame(franGET_json)
  invisible(franGET_df)
  return(franGET_df)
}

head(fetchFranTotal(n))
```

## Return `franchise team totals` by Team Name
```{r fun5}
fetchFranNameTotal <- function(tab, name) {
  URL <- "https://records.nhl.com/site/api/franchise-team-totals"
  franGET <- GET(URL)
  franGET_text <- content(franGET, "text")
  franGET_json <- fromJSON(franGET_text, flatten=TRUE)
  franGET_df <- as.data.frame(franGET_json)
  invisible(franGET_df)
  return(franGET_df %>% filter(data.teamName==name))
}
```

## Return `franchise team totals` by Franchise ID
```{r fun6}
fetchFranIDTotal <- function(tab, franID) {
  URL <- "https://records.nhl.com/site/api/franchise-team-totals"
  franGET <- GET(URL)
  franGET_text <- content(franGET, "text")
  franGET_json <- fromJSON(franGET_text, flatten=TRUE)
  franGET_df <- as.data.frame(franGET_json)
  invisible(franGET_df)
  return(franGET_df %>% filter(data.franchiseId==franID))
}
```


## Return `franchise season records` by Franchise ID
```{r fun7, echo=TRUE}
fetchSeasonRecords <- function(ID, ...) {
  URL <- "https://records.nhl.com/site/api/franchise-season-records?cayenneExp=franchiseId="
  ID <- ID
  fullURL <- paste0(URL,ID)
  franGET <- GET(fullURL)
  franGET_text <- content(franGET, "text")
  franGET_json <- fromJSON(franGET_text, flatten=TRUE)
  return(franGET_json)
}
```

## Return `goalie records` by Franchise ID
```{r fun8}
fetchGoalieRecords <- function(ID, ...) { 
  URL <- "https://records.nhl.com/site/api/franchise-goalie-records?cayenneExp=franchiseId="
  ID <- ID
  fullURL <- paste0(URL,ID)
  franGET <- GET(fullURL)
  franGET_text <- content(franGET, "text")
  franGET_json <- fromJSON(franGET_text, flatten=TRUE)
  return(franGET_json)
}
```

## Return `skater records` by Franchise ID
```{r fun9}
fetchSkaterRecords <- function(ID, ...) {
  URL <- "https://records.nhl.com/site/api/franchise-skater-records?cayenneExp=franchiseId="
  ID <- ID
  fullURL <- paste0(URL,ID)
  franGET <- GET(fullURL)
  franGET_text <- content(franGET, "text")
  franGET_json <- fromJSON(franGET_text, flatten=TRUE)
  return(franGET_json)
}
```


## Return `team stats` data
```{r fun10}
roster <- GET("https://statsapi.web.nhl.com/api/v1/teams/?expand=team.roster") %>% content("text") %>% fromJSON(flatten=TRUE)


fetchRosterLess <- function(ID=NULL, ...) { GET(paste0("https://statsapi.web.nhl.com/api/v1/teams/", ID, "/roster")) %>% content("text") %>% fromJSON(flatten=TRUE)
}

fetchPersonData <- GET("https://statsapi.web.nhl.com/api/v1/teams/?expand=person.names") %>% content("text") %>% fromJSON(flatten=TRUE)


fetchNextGame <- GET("https://statsapi.web.nhl.com/api/v1/teams/?expand=team.schedule.next") %>% content("text") %>% fromJSON(flatten=TRUE)

fetchLastGame <- GET("https://statsapi.web.nhl.com/api/v1/teams/?expand=?expand=team.schedule.previous") %>% content("text") %>% fromJSON(flatten=TRUE)


fetchSeasonStats <- GET("https://statsapi.web.nhl.com/api/v1/teams/?expand=?expand=team.stats") %>% content("text") %>% fromJSON(flatten=TRUE)

rosterBySeason <- GET("https://statsapi.web.nhl.com/api/v1/teams/?expand=team.roster&season=20142015") %>% content("text") %>% fromJSON(flatten=TRUE)
rosterBySeason[2]

fetchMultiTeams <- GET("https://statsapi.web.nhl.com/api/v1/teams/?teamId=4,5,29") %>% content("text") %>% fromJSON(flatten=TRUE)


fetchMultiStats <- GET("https://statsapi.web.nhl.com/api/v1/teams/?stats=statsSingleSeasonPlayoffs") %>% content("text") %>% fromJSON(flatten=TRUE)
```

```{r}
fetchSeasonStats
```

<br>
## Wrapper function
<br>

# Data Manipulation
<br>

## Joins
<br>


## Creating New Variables
<br>
Pulling in franchise data using the fetchFranTotal() function, I filtered the dataset to only include active franchises then put in order of first season. From here, I cut the data into 2 chunks representing franchises more than 50 years old ("Oldest") and team less then 50 years old ("Newest").
```{r var1, echo=TRUE}
franData <- fetchFranTotal() %>% filter(data.activeFranchise==1) %>% arrange(data.firstSeasonId)
franData <- franData %>% as_tibble() %>% 
  mutate(franAge = ifelse(franData$data.firstSeasonId >= 19701971, "Newest", "Oldest"))
```
<br>
I thought it would also be nice to look at this dataset and be able to quickly ascertain what the win percentage was for each team. In order to accomplish this, I created the variable `winPct` that reflects total wins divided by total games played. This is a particularly interesting variable and reveals much even in table form. After sorting by `winPct`, one can quickly glimpse the winningest franchises in hockey history. 
```{r var2, echo=TRUE}
franData <- franData %>% as_tibble() %>% mutate(winPct = (data.wins)/(data.gamesPlayed)) %>% arrange(desc(winPct))
```

# Data Exploration & Visualization

## Summarizing Numeric Data
<br>
The tables below provide some basic numeric summarization using data from one of hockey's most storied franchises: the Montreal Canadiens. I've pulled in Skater Records using our fetchSkaterRecords() function, setting ID=1, to get started. Because this data is in list form, I will convert it to a data frame. Next, I've written code to create a basic five number summary of assists and goals by skater position. Because I'll need to generate tables across four positions (R - right wing; C - center; L - left wing; D - defensemen), I'll create a function called summByPosition() to help automate this process. 
```{r numsumm, echo=TRUE}
canadiensSkaterRec <- fetchSkaterRecords(ID=1)
canSkateRec <- as.data.frame(canadiensSkaterRec)

summByPosition <- function(position) {
  data <- canSkateRec %>% filter(data.positionCode==position) %>% select(data.assists, data.goals)
  kable(apply(data, 2, summary), col.names=c("Assists", "Goals"), caption = paste0("Historical Summary of Assists & Goals Scored by Position=", position, " for the Montreal Canadiens"))
}

summByPosition("R")
summByPosition("C")
summByPosition("L")
summByPosition("D")
```
<br>
The tables generated above reveal that right wing(R), left wing(L) and centers(C) score, on average, higher than defensemen (D). This aligns with what I would've expected given the fact that offensive positions are tasked with being a team's primary scorers, while defensive positions are not. I was somewhat surprised to see that, though defense trails offense in assists on average, that it wasn't by much when comparing left wingers to defensemen.
<br>

## Summarizing Categorical Data
<br>
Working with the franchise records data and the new variable `franAge` created previously, I have created a contingency table below that shows the frequency of franchises by age classification (either Oldest or Newest). Newest franchises are more frequent by almost double that of Oldest franchises, however, that data is somewhat misleading. Each franchise appears twice in the dataset based on type of season. See more below. 
```{r catsumm1, echo=TRUE}
kable(table(franData$franAge))
```
<br>
Adding a second variable, `gameTypeId`, we get a two way contingency table that shows the frequency of franchises by age status and season type. This table tells us that there are 15 teams classified as "Oldest" and all teams with that classification have had a regular season and a post season in hockey history. However, the Newest franchises appears to have 29 teams classified as such, with one team not ever having had a post-season.
```{r catsumm2, echo=TRUE}
kable(table(franData$franAge, franData$data.gameTypeId), col.names = c("Regular Season", "Playoffs"))
```
<br>

#Graphing
<br>

## Boxplot: Winning Percentage by Franchise Age
The visual below shows boxplots of winning percentage by franchise age classification. The plots reveal that the newest franchises have greater variability in winning percentage than teams classified "Oldest".
```{r boxplot1, echo=TRUE}
ggplot(franData, aes(x = franAge, y = winPct)) + geom_boxplot() + geom_jitter(aes(color=franAge)) + ggtitle("Boxplot of Winning Percentage by Franchise Age") + ylab("Winning Percentage") + xlab("Franchise Age Classification")
```
<br>

## Scatterplot: Total Wins v. Road Wins
The overarching purpose of the scatterplot below is to compares total wins and road wins. We can see a vey strong, positive linear association between these two variables, which I expected. Winning games away from home is generally more challenging that in front of a friendly home crowd so I expected as the road wins increased, so too would oveall wins and the success of the franchise. I also a color grouping so that we can see the age of franchises. In this case, the major insight to be drawn from this is that the oldest franchises tend to have the overall most wins -- which again makes sense because older teams have been playing longer and simply have the opportunity to win more games than newer franchises. 
```{r scatter, echo=TRUE}
ggplot(franData, aes(x = data.wins, y = data.roadWins)) + geom_jitter(aes(color=franAge)) + ggtitle("Scatterplot of Total Wins vs. Road Wins") + ylab("Wins on the Road") + xlab("Total Wins")
```
<br>
## Scatterplot: Total Losses vs. Total Penalty Minutes
The scatterplot below shows total losses compared to total penalty minutes by franchise. This has a moderately strong positive linear association, though not quite as strong as the relationship seen in the previous plot. I expected this correlation given that players in penalty boxes generally give their team a disadvantage by allowing the other team a power play (unless of course the other team is penalized similarly at the exact same time and thus may experience more losses. Time does look to play a role here. We see the oldest franchises again having a higher number of penalty minutes and a higher number of losses, which again make sense because they have simply have longer (i.e more opportunity) to experience those things ove newer franchises. 
```{r scatter2, echo=TRUE}
ggplot(franData, aes(x = data.losses, y = data.penaltyMinutes, group=franAge)) + geom_jitter(aes(color=franAge)) + ggtitle("Scatterplot of Total Losses vs. Penalty Minutes") + ylab("Total Penalty Minutes") + xlab("Total Losses")
```

<br>
## Histogram: Frequency of Seasons Played by Vancouver Canucks Goalies
The histogram below shows the frequency of seasons played by goalies for the Vancouver Canucks. The distribution is right skewed revealing that goalies most frequently play 1 to 2 seasons.
```{r}
vanGoalieData <- fetchGoalieRecords(ID=20)
vanGoalieData <- vanGoalieData[[1]][26]

ggplot(vanGoalieData, aes(x=seasons)) + geom_histogram(bins=10) + ggtitle("Histogram of Seasons Played by Vancouver Canucks Goalies") + xlab("Seasons Played")
```
<br>

## Barplot
Using skater data from the Montreal Canadiens that we looked at earlier, I've developed a barplot to show the count of max goals scored in one game broken down by position. We see defensemen showing high counts for both zero and one goal max per game, which makes sense since it isn't their primary job to score. As the max number of goals per game increases, we see the counts for defensive positions fall off significantly. Counts for offensive positions at all available max goals is similar for zero to two goals max and begins to decline moderatly from there as we look from left to right across the barplot. Centers was the only position to register 6 goals max per game (the largest per game total recorded for the Canadiens).
```{r barplot, echo=TRUE}
canSkateRec 

ggplot(canSkateRec, aes(x=data.mostGoalsOneGame)) + geom_bar(aes(fill=data.positionCode), position="dodge") + scale_fill_discrete("Position") + xlab("Max Goals in One Game") + ggtitle("Barplot of Max Goals/Game by Position")
```

