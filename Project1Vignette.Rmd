---
title: "Project 1 Vignette: Reading In and Exploring Data via an API"
author: "Kelly Baker"
date: "9/10/2020"
output: 
  rmarkdown::github_document:
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(DT)
```

# Introduction
<br>
This vignette will walk you through how to connect with data through an API. Specifically, we will look at how to access certain endpoints (tables) as well as how join returned datasets, create new variables, and explore the data.
<br>

## Required Packages
<br>
To get started, we'll need to ensure we have the tools installed and loaded into RStudio to read in, manipulate, summarize, and plot the data. Below is an outline of packages that are required to for this project:
<br>

* **dplyr**: for data manipulation
* **DT**: for creating interactive data tables. 
* **ggplot2**: for plotting and graphing
* **readr**: for reading in data
* **tibble**: for creating special data frames with improved printing properties
* **tidyr**: for reshaping data
* **jsonlite**: for parsing API data
* **httr**: for streaming data from an API
<br>

We'll read in the packages using the library() function:
```{r packages, echo=TRUE}
library(dplyr)
library(DT)
library(ggplot2)
library(readr)
library(tibble)
library(tidyr)
library(jsonlite)
library(httr)
```
<br>

# API Function Calls

<br>

## Return `franchise` data set
```{r fun1, echo=TRUE, message=FALSE, warning=FALSE, error=TRUE}
fetchFran <- function(tab) {
  URL <- "https://records.nhl.com/site/api/franchise"
  franGET <- GET(URL)
  franGET_text <- content(franGET, "text")
  franGET_json <- fromJSON(franGET_text, flatten=TRUE)
  franGET_df <- as.data.frame(franGET_json)
  invisible(franGET_df)
  return(franGET_df)
}

fetchFran()
```

## Return `franchise` data by Team Name
```{r fun2, echo=TRUE, message=FALSE, warning=FALSE, error=TRUE}
fetchFranName <- function(tab, name) {
  URL <- "https://records.nhl.com/site/api/franchise"
  franGET <- GET(URL)
  franGET_text <- content(franGET, "text")
  franGET_json <- fromJSON(franGET_text, flatten=TRUE)
  franGET_df <- as.data.frame(franGET_json)
  invisible(franGET_df)
  return(franGET_df %>% filter(data.teamCommonName==name))
}

fetchFranName(name="Tigers")
```

## Return `franchise` data by Team ID
```{r fun3, echo=TRUE, message=FALSE, warning=FALSE, error=TRUE}
fetchFranID <- function(tab, id) {
  URL <- "https://records.nhl.com/site/api/franchise"
  franGET <- GET(URL)
  franGET_text <- content(franGET, "text")
  franGET_json <- fromJSON(franGET_text, flatten=TRUE)
  franGET_df <- as.data.frame(franGET_json)
  invisible(franGET_df)
  return(franGET_df %>% filter(data.id==id))
}

fetchFranID(id=1)
```

## Return `franchise team totals` dataset
```{r fun4}
fetchFranTotal <- function(tab, ...) {
  URL <- "https://records.nhl.com/site/api/franchise-team-totals"
  franGET <- GET(URL)
  franGET_text <- content(franGET, "text")
  franGET_json <- fromJSON(franGET_text, flatten=TRUE)
  franGET_df <- as.data.frame(franGET_json)
  invisible(franGET_df)
  return(franGET_df)
}

head(fetchFranTotal(n))
```

## Return `franchise team totals` by Team Name
```{r fun5}
fetchFranNameTotal <- function(tab, name) {
  URL <- "https://records.nhl.com/site/api/franchise-team-totals"
  franGET <- GET(URL)
  franGET_text <- content(franGET, "text")
  franGET_json <- fromJSON(franGET_text, flatten=TRUE)
  franGET_df <- as.data.frame(franGET_json)
  invisible(franGET_df)
  return(franGET_df %>% filter(data.teamName==name))
}

fetchFranNameTotal(name="Boston Bruins")
```

## Return `franchise team totals` by Franchise ID
```{r fun6}
fetchFranIDTotal <- function(tab, franID) {
  URL <- "https://records.nhl.com/site/api/franchise-team-totals"
  franGET <- GET(URL)
  franGET_text <- content(franGET, "text")
  franGET_json <- fromJSON(franGET_text, flatten=TRUE)
  franGET_df <- as.data.frame(franGET_json)
  invisible(franGET_df)
  return(franGET_df %>% filter(data.franchiseId==franID))
}

fetchFranIDTotal(franID=8)
```


## Return `franchise season records` by Franchise ID
```{r fun7, echo=TRUE}
fetchSeasonRecords <- function(ID, ...) {
  URL <- "https://records.nhl.com/site/api/franchise-season-records?cayenneExp=franchiseId="
  ID <- ID
  fullURL <- paste0(URL,ID)
  franGET <- GET(fullURL)
  franGET_text <- content(franGET, "text")
  franGET_json <- fromJSON(franGET_text, flatten=TRUE)
  return(franGET_json)
}

fetchSeasonRecords(ID=6)
```

## Return `goalie records` by Franchise ID
```{r fun8}
fetchGoalieRecords <- function(ID, ...) { 
  URL <- "https://records.nhl.com/site/api/franchise-goalie-records?cayenneExp=franchiseId="
  ID <- ID
  fullURL <- paste0(URL,ID)
  franGET <- GET(fullURL)
  franGET_text <- content(franGET, "text")
  franGET_json <- fromJSON(franGET_text, flatten=TRUE)
  return(franGET_json)
}

fetchGoalieRecords(ID=12)
```

## Return `skater records` by Franchise ID
```{r fun9}
fetchSkaterRecords <- function(ID, ...) {
  URL <- "https://records.nhl.com/site/api/franchise-skater-records?cayenneExp=franchiseId="
  ID <- ID
  fullURL <- paste0(URL,ID)
  franGET <- GET(fullURL)
  franGET_text <- content(franGET, "text")
  franGET_json <- fromJSON(franGET_text, flatten=TRUE)
  return(franGET_json)
}

fetchSkaterRecords(ID=9)
```

## Return `team stats` data
```{r fun10}
fetchTeamStats <- function(type, ...) {
  URL <- "https://statsapi.web.nhl.com/api/v1/teams"
  mod1 <- "?expand=team.roster"
  mod2 <- "?expand=person.names"
  mod3 <- "?expand=team.schedule.next"
  mod4 <- "?expand=team.schedule.previous"
  mod5 <- "?expand=team.stats"
  mod6 <- "?expand=team.roster&season=20142015"
  mod7 <- "?teamId=4,5,29"
  mod8 <- "?stats=statsSingleSeasonPlayoffs"
  switch(type,
         roster = paste0(URL, "/", mod1),
         rosterLess = paste0(URL, "/", mod2),
         nextGame = paste0(URL, "/", mod3),
         lastGame = paste0(URL, "/", mod4),
         teamStats = paste(URL, "/", mod5),
         rosterBySeason = paste0(URL, "/", mod6),
         mulitpleTeams = paste0(URL, "/", mod7),
         multipleStats = paste0(URL, "/", mod8))
}
  franGET <- GET(type)
  franGET_text <- content(franGET, "text")
  franGET_json <- fromJSON(franGET_text, flatten=TRUE)
  return(franGET_json)
}

fetchTeamStats("roster")
```

