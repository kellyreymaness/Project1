---
title: "Project 1 Vignette: Reading In and Exploring Data via an API"
author: "Kelly Baker"
date: "9/10/2020"
output: 
  rmarkdown::github_document:
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(DT)
```

# Introduction
<br>
This vignette will walk you through how to connect with data through an API. Specifically, we will look at how to access certain endpoints (tables) as well as how join returned datasets, create new variables, and explore the data.
<br>

## Required Packages
<br>
To get started, we'll need to ensure we have the tools installed and loaded into RStudio to read in, manipulate, summarize, and plot the data. Below is an outline of packages that are required to for this project:
<br>

* **dplyr**: for data manipulation
* **DT**: for creating interactive data tables. 
* **ggplot2**: for plotting and graphing
* **readr**: for reading in data
* **tibble**: for creating special data frames with improved printing properties
* **tidyr**: for reshaping data
* **jsonlite**: for parsing API data
* **httr**: for streaming data from an API
* **knitr**: for creating tables with nic printing properties
<br>

We'll read in the packages using the library() function:
```{r packages, echo=TRUE}
library(dplyr)
library(DT)
library(ggplot2)
library(readr)
library(tibble)
library(tidyr)
library(jsonlite)
library(httr)
library(knitr)
```
<br>

# API Function Calls
<br>

## Return `franchise` data set
```{r fun1, echo=TRUE, message=FALSE, warning=FALSE, error=TRUE}
fetchFran <- function(tab) {
  URL <- "https://records.nhl.com/site/api/franchise"
  franGET <- GET(URL)
  franGET_text <- content(franGET, "text")
  franGET_json <- fromJSON(franGET_text, flatten=TRUE)
  franGET_df <- as.data.frame(franGET_json)
  invisible(franGET_df)
  return(franGET_df)
}

fetchFran()
```

## Return `franchise` data by Team Name
```{r fun2, echo=TRUE, message=FALSE, warning=FALSE, error=TRUE}
fetchFranName <- function(tab, name) {
  URL <- "https://records.nhl.com/site/api/franchise"
  franGET <- GET(URL)
  franGET_text <- content(franGET, "text")
  franGET_json <- fromJSON(franGET_text, flatten=TRUE)
  franGET_df <- as.data.frame(franGET_json)
  invisible(franGET_df)
  return(franGET_df %>% filter(data.teamCommonName==name))
}

fetchFranName(name="Tigers")
```

## Return `franchise` data by Team ID
```{r fun3, echo=TRUE, message=FALSE, warning=FALSE, error=TRUE}
fetchFranID <- function(tab, id) {
  URL <- "https://records.nhl.com/site/api/franchise"
  franGET <- GET(URL)
  franGET_text <- content(franGET, "text")
  franGET_json <- fromJSON(franGET_text, flatten=TRUE)
  franGET_df <- as.data.frame(franGET_json)
  invisible(franGET_df)
  return(franGET_df %>% filter(data.id==id))
}

fetchFranID(id=1)
```

## Return `franchise team totals` dataset
```{r fun4}
fetchFranTotal <- function(tab, ...) {
  URL <- "https://records.nhl.com/site/api/franchise-team-totals"
  franGET <- GET(URL)
  franGET_text <- content(franGET, "text")
  franGET_json <- fromJSON(franGET_text, flatten=TRUE)
  franGET_df <- as.data.frame(franGET_json)
  invisible(franGET_df)
  return(franGET_df)
}

head(fetchFranTotal(n))
```

## Return `franchise team totals` by Team Name
```{r fun5}
fetchFranNameTotal <- function(tab, name) {
  URL <- "https://records.nhl.com/site/api/franchise-team-totals"
  franGET <- GET(URL)
  franGET_text <- content(franGET, "text")
  franGET_json <- fromJSON(franGET_text, flatten=TRUE)
  franGET_df <- as.data.frame(franGET_json)
  invisible(franGET_df)
  return(franGET_df %>% filter(data.teamName==name))
}

fetchFranNameTotal(name="Boston Bruins")
```

## Return `franchise team totals` by Franchise ID
```{r fun6}
fetchFranIDTotal <- function(tab, franID) {
  URL <- "https://records.nhl.com/site/api/franchise-team-totals"
  franGET <- GET(URL)
  franGET_text <- content(franGET, "text")
  franGET_json <- fromJSON(franGET_text, flatten=TRUE)
  franGET_df <- as.data.frame(franGET_json)
  invisible(franGET_df)
  return(franGET_df %>% filter(data.franchiseId==franID))
}

fetchFranIDTotal(franID=8)
```


## Return `franchise season records` by Franchise ID
```{r fun7, echo=TRUE}
fetchSeasonRecords <- function(ID, ...) {
  URL <- "https://records.nhl.com/site/api/franchise-season-records?cayenneExp=franchiseId="
  ID <- ID
  fullURL <- paste0(URL,ID)
  franGET <- GET(fullURL)
  franGET_text <- content(franGET, "text")
  franGET_json <- fromJSON(franGET_text, flatten=TRUE)
  return(franGET_json)
}

fetchSeasonRecords(ID=6)
```

## Return `goalie records` by Franchise ID
```{r fun8}
fetchGoalieRecords <- function(ID, ...) { 
  URL <- "https://records.nhl.com/site/api/franchise-goalie-records?cayenneExp=franchiseId="
  ID <- ID
  fullURL <- paste0(URL,ID)
  franGET <- GET(fullURL)
  franGET_text <- content(franGET, "text")
  franGET_json <- fromJSON(franGET_text, flatten=TRUE)
  return(franGET_json)
}

fetchGoalieRecords(ID=12)
```

## Return `skater records` by Franchise ID
```{r fun9}
fetchSkaterRecords <- function(ID, ...) {
  URL <- "https://records.nhl.com/site/api/franchise-skater-records?cayenneExp=franchiseId="
  ID <- ID
  fullURL <- paste0(URL,ID)
  franGET <- GET(fullURL)
  franGET_text <- content(franGET, "text")
  franGET_json <- fromJSON(franGET_text, flatten=TRUE)
  return(franGET_json)
}

fetchSkaterRecords(ID=9)
```


## Return `team stats` data
```{r fun10}
roster <- GET("https://statsapi.web.nhl.com/api/v1/teams/?expand=team.roster") %>% content("text") %>% fromJSON(flatten=TRUE)


fetchRosterLess <- function(ID=NULL, ...) { GET(paste0("https://statsapi.web.nhl.com/api/v1/teams/", ID, "/roster")) %>% content("text") %>% fromJSON(flatten=TRUE)
}

fetchPersonData <- GET("https://statsapi.web.nhl.com/api/v1/teams/?expand=person.names") %>% content("text") %>% fromJSON(flatten=TRUE)


fetchNextGame <- GET("https://statsapi.web.nhl.com/api/v1/teams/?expand=team.schedule.next") %>% content("text") %>% fromJSON(flatten=TRUE)

fetchLastGame <- GET("https://statsapi.web.nhl.com/api/v1/teams/?expand=?expand=team.schedule.previous") %>% content("text") %>% fromJSON(flatten=TRUE)


fetchSeasonStats <- GET("https://statsapi.web.nhl.com/api/v1/teams/?expand=?expand=team.stats") %>% content("text") %>% fromJSON(flatten=TRUE)

rosterBySeason <- GET("https://statsapi.web.nhl.com/api/v1/teams/?expand=team.roster&season=20142015") %>% content("text") %>% fromJSON(flatten=TRUE)
rosterBySeason[2]

fetchMultiTeams <- GET("https://statsapi.web.nhl.com/api/v1/teams/?teamId=4,5,29") %>% content("text") %>% fromJSON(flatten=TRUE)
fetchMultiTeams

fetchMultiStats <- GET("https://statsapi.web.nhl.com/api/v1/teams/?stats=statsSingleSeasonPlayoffs") %>% content("text") %>% fromJSON(flatten=TRUE)
fetchMultiStats
```

```{r}

```

<br>
## Wrapper function
<br>

# Data Manipulation
<br>
```{r}

str(fetchSkaterRecords(ID=1))
```

## Joins
<br>


## Creating New Variables
<br>
Pulling in franchise data using the fetchFranTotal() function, I filtered the dataset to only include active franchises then put in order of first season. From here, I cut the data into 5 chunks representing roughly 15 to 20 year increments and created a new variable based on age of the franchises called `franAge`. The categories assigned were Oldest, Older, Old, New and Newest. 
```{r var1, echo=TRUE}
franData <- fetchFranTotal() %>% filter(data.activeFranchise==1) %>% arrange(data.firstSeasonId)
franData %>% as_tibble() %>% 
  mutate(franAge = ifelse(franData$data.firstSeasonId >= 20012002, "Newest",
       ifelse(franData$data.firstSeasonId >= 19951996, "New",
              ifelse(franData$data.firstSeasonId >= 19801981, "Old",
                     ifelse(franData$data.firstSeasonId >= 19671968, "Older", "Oldest")))))
franData
```
<br>
I thought it would also be nice to look at this dataset and be able to quickly ascertain what the win percentage was for each team. In order to accomplish this, I created the variable `winPct` that reflects total wins divided by total games played. This is a particularly interesting variabile and reveals much even in table form. You can quickly see win percentages by team by game type (i.e. regualar season vs. playoffs).
```{r var2, echo=TRUE}
franData %>% as_tibble() %>% mutate(winPct = (data.wins + data.ties)/(data.wins + data.ties + data.losses))
```


# Data Exploration & Visualization

## Summarizing Numeric Data
<br>
The tables below provide some basic numeric summarization using data from one of hockey's most storied franchises: the Montreal Canadiens. I've pulled in Skater Records using our fetchSkaterRecords() function, setting ID=1, to get started. Because this data is in list form, I will convert it to a data frame. Next, I've written code to create a basic five number summary of assists and goals by skater position. Because I'll need to generate tables across four positions (R - right wing; C - center; L - left wing; D - defensemen), I'll create a function called summByPosition() to help automate this process. 
```{r numsumm, echo=TRUE}
canadiensSkaterRec <- fetchSkaterRecords(ID=1)
canSkateRec <- as.data.frame(canadiensSkaterRec)

summByPosition <- function(position) {
  data <- canSkateRec %>% filter(data.positionCode==position) %>% select(data.assists, data.goals)
  kable(apply(data, 2, summary), col.names=c("Assists", "Goals"), caption = paste0("Historical Summary of Assists & Goals Scored by Position=", position, " for the Montreal Canadiens"))
}

summByPosition("R")
summByPosition("C")
summByPosition("L")
summByPosition("D")
```
The tables generated above reveal that right wing(R), left wing(L) and centers(C) score, on average, higher than defensemen (D). This aligns with what I would've expected given the fact that offensive positions are tasked with being a team's primary scorers, while defensive positions are not. I was somewhat surprised to see that, though defense trails offense in assists on average, that it wasn't by much when comparing left wingers to defensemen.
<br>

## Summarizing Categorical Data
<br>
```{r catsumm, echo=TRUE}
franData <- fetchFranTotal() %>% filter(data.activeFranchise==1) %>% arrange(data.firstSeasonId)
franData %>% as_tibble() %>% 
  mutate(franAge = ifelse(franData$data.firstSeasonId >= 20012002, "Newest",
       ifelse(franData$data.firstSeasonId >= 19951996, "New",
              ifelse(franData$data.firstSeasonId >= 19801981, "Old",
                     ifelse(franData$data.firstSeasonId >= 19671968, "Older", "Oldest")))))
```
<br>

#Graphing
<br>

